<?xml version="1.0" encoding="UTF-8" ?>

<simple-methods xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://ofbiz.apache.org/dtds/simple-methods-v2.xsd">
        
    <simple-method method-name="createCustRequestSupplementory"
        short-description="Create accounting preference settings for a party">
        <make-value value-field="newEntity" entity-name="CustRequestSupplementory"/>
        <set-pk-fields map="parameters" value-field="newEntity"/>
        <set-nonpk-fields map="parameters" value-field="newEntity"/>
        <create-value value-field="newEntity"/>
    </simple-method>
    <simple-method method-name="createCustRequestChannelPweb"
        short-description="createCustRequestChannelPweb for cust request">
        <make-value value-field="newEntity" entity-name="CustRequestChannelPweb"/>
        <set-pk-fields map="parameters" value-field="newEntity"/>
        <set-nonpk-fields map="parameters" value-field="newEntity"/>
        <create-value value-field="newEntity"/>
    </simple-method>
    
    <simple-method method-name="updateCustRequestSupplementory"
        short-description="update CustRequestSupplementory">
        <make-value value-field="newEntity" entity-name="CustRequestSupplementory"/>
        <set-pk-fields map="parameters" value-field="newEntity"/>
        <set-nonpk-fields map="parameters" value-field="newEntity"/>
        <store-value value-field="newEntity"/>
    </simple-method>
    
    <simple-method method-name="updateCustRequestChannelPweb"
        short-description="update CustRequestChannelPweb for cust request">
        <make-value value-field="newEntity" entity-name="CustRequestChannelPweb"/>
        <set-pk-fields map="parameters" value-field="newEntity"/>
        <set-nonpk-fields map="parameters" value-field="newEntity"/>
        <store-value value-field="newEntity"/>
    </simple-method>
    
    <simple-method method-name="crm.setCustRequestStatus" short-description="change the customer request Status">
        <entity-one entity-name="CustRequest" value-field="custRequest"/>
        <if-not-empty field="custRequest">
            <field-to-result field="custRequest.statusId" result-name="oldStatusId"/>
            <field-to-result field="custRequest.custRequestId"  result-name="custRequestId"/>
            <field-to-result field="custRequest.fromPartyId" result-name="fromPartyId"/><!-- for notification -->
            <field-to-result field="custRequest.custRequestName" result-name="custRequestName"/><!-- for notification -->
            <if-compare-field field="custRequest.statusId" to-field="parameters.statusId" operator="not-equals">
                <entity-one entity-name="StatusValidChange" value-field="statusChange">
                    <field-map field-name="statusId" from-field="custRequest.statusId"/>
                    <field-map field-name="statusIdTo" from-field="parameters.statusId"/>
                </entity-one>
                <if-empty field="statusChange">
                    <set field="msg" value="Status is not a valid change: from ${custRequest.statusId} to ${parameters.statusId}"/>
                    <log level="error" message="${msg}"/>
                    <add-error>
                        <fail-property resource="OrderErrorUiLabels" property="OrderErrorCouldNotChangeOrderStatusFromTo"/>
                    </add-error>
                </if-empty>
            </if-compare-field>
        </if-not-empty>
        
        <check-errors/>

        <set field="custRequest.statusId" from-field="parameters.statusId"/>
        <if-not-empty field="parameters.reason"><!-- update reason if provided -->
            <set field="custRequest.reason" from-field="parameters.reason"/>
        </if-not-empty>
        <now-timestamp field="custRequest.lastModifiedDate"/>
        <store-value value-field="custRequest"/>
        <call-simple-method method-name="createCustRequestStatus"/>
    </simple-method>
    <simple-method method-name="createCustRequestStatus" short-description="Create Customer Request Status">
        <make-value value-field="newEntity" entity-name="CustRequestStatus"/>
        <sequenced-id sequence-name="CustRequestStatus" field="newEntity.custRequestStatusId"/>
        <set-nonpk-fields map="parameters" value-field="newEntity"/>
        <if-empty field="newEntity.statusDatetime">
            <now-timestamp field="nowTimestamp"/>
            <set from-field="nowTimestamp" field="newEntity.statusDatetime"/>
        </if-empty>
        <create-value value-field="newEntity"/>
    </simple-method>
</simple-methods>